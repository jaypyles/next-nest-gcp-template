name: Deploy to Cloud Run

description: 'Deploys Services to GCP.'

inputs:
  app-name:
    description: 'The name of the app'
    required: true
    type: string
  gcp-project:
    description: 'The GCP project'
    required: true
    type: string
  gcp-region:
    description: 'The GCP region'
    required: true
    type: string
  gcp-sa:
    description: 'The GCP service account email'
    required: true
    type: string
  gcp-sa-key:
    description: 'The GCP service account key'
    required: true
    type: string
  dockerhub-repo:
    description: 'The Docker Hub repository'
    required: true
    type: string

runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Get short SHA
      id: vars
      run: |
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      shell: bash

    - name: Deploy
      run: echo "Deploying to GCP"
      shell: bash

    - name: Set up GCP credentials
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ inputs.gcp-project }}
        service_account_key: ${{ inputs.gcp-sa-key }}

    - name: Deploy to Cloud Run
      run: |
        gcloud config set account 

        gcloud run deploy ${{ inputs.app-name }} \
          --image docker.io/${{ inputs.dockerhub-repo }}:${{ steps.vars.outputs.sha_short }} \
          --platform managed \
          --region ${{ inputs.gcp-region }} \
          --max-instances 1 \
          --timeout 30 \
          --memory 1Gi \
          --cpu 1 \
          --allow-unauthenticated
      shell: bash
